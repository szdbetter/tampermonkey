# 数据加工能力说明

## 基本概念

数据加工能力是多链套利系统中的关键组成部分，它位于数据采集能力之后，负责将采集到的原始数据进行运算和处理，产生具有业务含义的新数据，为策略执行提供决策依据。

## 业务流程

1. 选择关联的数据采集节点，获取其传出参数
2. 选择要处理的输入参数
3. 定义计算公式和中间变量
4. 设置输出参数
5. 测试验证计算结果

## 数据模型

### 数据加工配置 (DataProcessingConfig)

```typescript
interface DataProcessingConfigModel {
  NO?: number;              // 节点编号，自动生成
  name: string;             // 节点名称
  sourceNodeId: number;     // 关联的数据采集节点ID
  inputParams: Array<{      // 输入参数列表
    name: string;           // 参数名称
    type: string;           // 参数类型
    value?: any;            // 参数值
    selected?: boolean;     // 是否选择作为计算输入
  }>;
  formulas: Array<{         // 公式列表
    name: string;           // 公式名称
    formula: string;        // 公式内容
    description?: string;   // 公式描述
  }>;
  outputParams: Array<{     // 输出参数列表
    name: string;           // 参数名称
    type: string;           // 参数类型
    value?: string;         // 引用值（公式结果或输入参数）
  }>;
  active: boolean;          // 是否启用
  create_time?: number;     // 创建时间
}
```

## 功能特点

### 1. 变量嵌套和引用

数据加工能力支持公式间的嵌套引用，例如可以先定义一个"占用时长"变量，然后在计算APY时引用该变量：

```
占用时长 = 锁定时间(天) * 24  // 转换为小时
APY = (收益 / 本金) * 365 / 占用时长 * 24
```

### 2. 实时计算和测试

系统提供实时计算功能，用户可以随时测试公式的计算结果，确保数据处理的准确性。

### 3. 灵活的输入/输出配置

- 可以从关联的数据采集节点选择需要的输入参数
- 可以定义任意数量的中间计算公式
- 可以配置多个输出参数，引用任何公式结果或直接引用输入参数

## 使用场景

### 场景一：计算DeFi协议的年化收益率(APY)

1. 关联获取质押收益的数据采集节点
2. 选择"收益金额"、"本金金额"、"锁定天数"作为输入参数
3. 创建公式：`APY = (收益 / 本金) * 365 / 锁定天数`
4. 将APY设置为输出参数

### 场景二：计算跨链套利利润率

1. 关联获取不同链上资产价格的数据采集节点
2. 选择"链A价格"、"链B价格"、"Gas费用"作为输入参数
3. 创建公式：
   - `价格差 = 链B价格 - 链A价格`
   - `成本 = Gas费用 / 交易数量`
   - `利润率 = (价格差 - 成本) / 链A价格 * 100`
4. 将"利润率"设置为输出参数

## 技术实现

数据加工能力基于以下技术实现：

1. 使用localStorage存储配置数据
2. 动态编译JavaScript表达式进行计算
3. React Hooks管理状态和副作用
4. CSS-in-JS实现界面样式

## 注意事项

1. 公式中引用的变量名称必须与输入参数或已定义的公式名称完全一致
2. 数字类型的计算结果会自动处理精度问题
3. 公式计算遵循JavaScript的语法规则
4. 每个数据加工节点必须关联一个数据采集节点 